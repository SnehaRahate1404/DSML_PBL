{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static "css/style.css" %}">
    <title>Document</title>
</head>
<style>
  body{
    margin: 0;
    height:100vh;
    background-image: linear-gradient(rgb(211, 60, 211), rgb(243, 243, 113));
    background-repeat: no-repeat;
}
</style>
<body >
    <nav class="navbar navbar-expand-lg background">
        <div class="container-fluid">
          <a class="navbar-brand" href="#" style="color: white;">Name of Website</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#" style="color: white;">Home</a>
              </li>
            </ul>
            <div class="button">
                <a href="login.html"><button type="button" class="btn btn-light">Register</button></a>
                <a href="profile.html"><img src="/static/images/profile.jpg" class="profile-icon" alt=""></a>
            </div> 
          </div>
        </div>
      </nav>

      <section class="chat">
        <div id="chatbot-container">
          <!-- Chat Header -->
          <div class="chat-header">
              Chatbot
          </div>
      
          <!-- Chat Messages Container -->
          <div id="chatbot">
              <p class="botText"><span>Hi there</span></p> <!-- Initial Bot Message -->
          </div>

          <!-- Timer Display -->
          <div id="timer" class="timer-display">
              <span>20:00</span> <!-- Initial timer value -->
          </div>

          <!-- User Input Container with Voice and Stop Buttons -->
          <div id="userInput">
              <button id="voiceButton" class="btn btn-primary">ðŸŽ¤ Voice Input</button>
              <button id="stopButton" class="btn btn-danger">Stop</button>
          </div>
        </div>
      </section>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
            let countdown; // Timer variable
            let isTimerStarted = false; // To track if the timer has started

            // Function to append messages to the chat container
            function appendMessage(sender, message) {
                let messageHTML = `<p class="${sender}Text"><span>${message}</span></p>`;
                document.getElementById('chatbot').innerHTML += messageHTML;
                document.getElementById('chatbot').scrollTop = document.getElementById('chatbot').scrollHeight;
            }

            // Timer function
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                countdown = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(countdown); // Clear countdown when timer ends
                        appendMessage('bot', 'Bot: Time is up!');
                    }
                }, 1000);
            }

            // Voice recognition using Web Speech API
            const voiceButton = document.getElementById('voiceButton');
            const stopButton = document.getElementById('stopButton');
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';

            // Start listening and timer when the voice button is clicked
            voiceButton.addEventListener('click', function() {
                if (!isTimerStarted) { // Start timer only if not started
                    const twentyMinutes = 60 * 20;
                    const display = document.querySelector('#timer span');
                    startTimer(twentyMinutes, display);
                    isTimerStarted = true; // Set the timer as started
                }

                recognition.start(); // Start voice recognition
            });

            // When the voice recognition captures a result
            recognition.onresult = function(event) {
                const message = event.results[0][0].transcript; // Get the recognized text
                appendMessage('user', 'You: ' + message); // Append user's message (DISPLAYED HERE)
                sendMessageToServer(message); // Send to backend
            };

            // Function to send message to the server
            function sendMessageToServer(message) {
                appendMessage('bot', 'Processing...');

                // Replace this URL with the correct one
                $.ajax({
                    url: '{% url "process_voice_message" %}',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 'message': message }),
                    success: function(data) {
                        appendMessage('bot', 'Bot: ' + data.response); // Append bot response
                    },
                    error: function() {
                        appendMessage('bot', 'Bot: I am having trouble understanding.');
                    }
                });
            }

            // Stop the timer and voice recognition when stop button is clicked
            stopButton.addEventListener('click', function() {
                clearInterval(countdown); // Stop the timer
                recognition.stop(); // Stop voice recognition
                appendMessage('bot', 'Bot: Voice input stopped.');
            });
        });
      </script>
</body>
</html>
